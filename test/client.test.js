"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("mocha");
var fs = require("fs");
var chai_importer_test_1 = require("./chai-importer.test");
var _ = require("lodash");
var path = require("upath");
var cleanStack = require("clean-stacktrace");
var rxjs_1 = require("rxjs");
var operators_1 = require("rxjs/operators");
var rimraf = require("rimraf");
var client_1 = require("../lib/client");
var ftpClient;
var cleanError = function (err) {
    var out = cleanStack(err.stack, function (line) {
        var m = /(node_modules)/.exec(line) || [];
        if (m[1]) {
            return null;
        }
        return line;
    });
    return _.assign(err, { stack: out.replace(/^[\r\n]{2,}/gm, '') });
};
var serverFTPTest = {
    host: 'ftp.dlptest.com',
    port: 21,
    user: 'dlpuser@dlptest.com',
    password: '3D6XZV9MKdhM5fF',
    debug: function (msg) {
        // console.log('\t\tFTP --> ' + msg);
    },
};
var options = {
    logging: 'debug',
};
ftpClient = new client_1.Client(serverFTPTest, options);
describe('Test connection', function () {
    it("connect to the test server", function (done) {
        var connected = false;
        ftpClient.connect().subscribe(function () { return connected = true; }, function (err) { return done(err); }, function () {
            chai_importer_test_1.expect(connected).to.be.true;
            chai_importer_test_1.expect(ftpClient.status).to.be.equal('connected');
            done();
        });
    });
    it("disconnect from the test server", function (done) {
        var connected = true;
        ftpClient.disconnect().subscribe(function () { return connected = false; }, function (err) { return done(err); }, function () {
            chai_importer_test_1.expect(connected).to.be.false;
            chai_importer_test_1.expect(ftpClient.status).to.be.equal('disconnected');
            done();
        });
    });
});
describe('Test upload', function () {
    var testFiles = [
        './test.txt',
        './dir',
        './dir/*',
    ];
    var remotePath = '/test';
    beforeEach(function (done) {
        this.timeout(0);
        ftpClient.connect().subscribe({
            error: function (err) { return done(err); },
            complete: function () { return done(); },
        });
    });
    afterEach(function (done) {
        this.timeout(0);
        ftpClient.connect().pipe(operators_1.switchMapTo(ftpClient.deleteRemoteFile({
            src: remotePath,
            isDirectory: function () { return true; },
        })), operators_1.switchMapTo(ftpClient.disconnect())).subscribe({
            error: function (err) { return done(err); },
            complete: function () { return done(); },
        });
    });
    it("upload one file to the test server", function (done) {
        ftpClient.upload(path.join(__dirname, testFiles[0]), remotePath, { baseDir: __dirname }).subscribe(function (results) {
            chai_importer_test_1.expect(results, 'No results returned').to.exist;
            chai_importer_test_1.expect(results.uploadedFiles).to.be.eql([
                path.join(__dirname, testFiles[0]),
            ]);
            chai_importer_test_1.expect(results.uploadedDirs).to.be.empty;
            chai_importer_test_1.expect(results.errors, 'Errors detected').to.be.empty;
        }, function (err) { return done(err); }, function () {
            chai_importer_test_1.expect(ftpClient.status).to.be.equal('disconnected');
            done();
        });
    }).timeout(20000);
    it("upload multiple files to the test server", function (done) {
        ftpClient.upload(_.map(testFiles, function (t) { return path.join(__dirname, t); }), remotePath, { baseDir: __dirname }).subscribe(function (results) {
            chai_importer_test_1.expect(results, 'No results returned').to.exist;
            chai_importer_test_1.expect(results.uploadedFiles).to.be.length(3);
            chai_importer_test_1.expect(results.uploadedDirs).to.be.length(1);
            chai_importer_test_1.expect(results.errors, 'Errors detected').to.be.empty;
        }, function (err) { return done(err); }, function () {
            chai_importer_test_1.expect(ftpClient.status).to.be.equal('disconnected');
            done();
        });
    }).timeout(20000);
});
describe.only('Test download', function () {
    var testFiles = [
        './test.txt',
        './dir',
        './dir/*',
    ];
    var remotePath = '/test';
    var downloadPath = '/download';
    beforeEach(function (done) {
        this.timeout(0);
        ftpClient.setConfig(serverFTPTest, _.assign(_.clone(options), {
            logging: 'none',
            baseDir: __dirname,
        }));
        ftpClient.connect().pipe(operators_1.tap(function () { return console.info('Before - Uploading test files'); }), operators_1.switchMapTo(ftpClient.upload(_.map(testFiles, function (t) { return path.join(__dirname, t); }), remotePath)), operators_1.tap(function () { return console.info('Before - Files uploaded, creating folder '
            + downloadPath); }), operators_1.switchMapTo(rxjs_1.bindNodeCallback(fs.mkdir).call(this, path.join(__dirname, downloadPath)).pipe(operators_1.catchError(function (err) {
            if (err.code === 'EEXIST') {
                return rxjs_1.of(null);
            }
            return rxjs_1.throwError(err);
        }))), operators_1.tap(function () { return console.info('Before - Done'); }), operators_1.tap(function () {
            console.info('Before - Set new config'),
                ftpClient.setConfig(_.assign(_.clone(serverFTPTest), {
                    logging: 'debug',
                    debug: function (msg) {
                        // console.log('\t\tFTP --> ' + msg);
                    },
                }), _.assign(_.clone(options), {}));
        }), operators_1.switchMapTo(ftpClient.connect()), operators_1.catchError(function (err) {
            ftpClient.setConfig(serverFTPTest, options);
            return rxjs_1.throwError(err);
        })).subscribe({
            error: function (err) { return done(err); },
            complete: function () { return done(); },
        });
    });
    afterEach(function (done) {
        this.timeout(0);
        ftpClient.setConfig(serverFTPTest, _.assign(_.clone(options), {
            logging: 'none',
        }));
        var endObservable = rxjs_1.of(null).pipe(operators_1.tap(function () {
            ftpClient.setConfig(serverFTPTest, options);
        }), operators_1.ignoreElements());
        ftpClient.connect().pipe(operators_1.tap(function () { return console.info('After - Disconnecting and cleaning folders'); }), operators_1.switchMapTo(ftpClient.deleteRemoteFile({
            src: remotePath,
            isDirectory: function () { return true; },
        })), operators_1.switchMapTo(rxjs_1.bindNodeCallback(rimraf).call(this, path.join(__dirname, downloadPath))), operators_1.switchMapTo(ftpClient.disconnect()), operators_1.tap(function () { return console.info('After - Done'); }), operators_1.concat(endObservable), operators_1.catchError(function (err) {
            return endObservable.pipe(operators_1.mapTo(rxjs_1.throwError(err)));
        })).subscribe({
            error: function (err) { return done(err); },
            complete: function () { return done(); },
        });
    });
    it("Download a folder from the test server", function (done) {
        var localFilePath = path.join(__dirname, downloadPath, testFiles[0]);
        ftpClient.download(remotePath, path.join(__dirname, downloadPath)).pipe(operators_1.catchError(function (err) {
            return ftpClient.disconnect().pipe(operators_1.switchMapTo(rxjs_1.throwError(err)));
        }))
            .subscribe(function (results) {
            chai_importer_test_1.expect(results, 'No results returned').to.exist;
            chai_importer_test_1.expect(results.downloadedFiles).to.be.length(3);
            chai_importer_test_1.expect(results.errors, 'Errors detected').to.be.empty;
            chai_importer_test_1.expect(chai_importer_test_1.file(path.join(localFilePath))).to.exist;
        }, function (err) { return done(err); }, function () {
            chai_importer_test_1.expect(ftpClient.status).to.be.equal('disconnected');
            done();
        });
    }).timeout(20000);
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICdtb2NoYSc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuaW1wb3J0ICogYXMgc2lub24gZnJvbSAnc2lub24nO1xyXG5pbXBvcnQgKiBhcyBmYWtlciBmcm9tICdmYWtlcic7XHJcbmltcG9ydCB7IGV4cGVjdCwgZmlsZSwgZGlyIH0gZnJvbSAnLi9jaGFpLWltcG9ydGVyLnRlc3QnO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAndXBhdGgnO1xyXG5pbXBvcnQgKiBhcyBjbGVhblN0YWNrIGZyb20gJ2NsZWFuLXN0YWNrdHJhY2UnO1xyXG5pbXBvcnQgeyBiaW5kTm9kZUNhbGxiYWNrLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge1xyXG4gIHN3aXRjaE1hcFRvLCB0YXAsIG9uRXJyb3JSZXN1bWVOZXh0LCBjb25jYXQsIGNhdGNoRXJyb3IsIG1hcFRvLFxyXG4gIGlnbm9yZUVsZW1lbnRzLFxyXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0ICogYXMgcmltcmFmIGZyb20gJ3JpbXJhZic7XHJcblxyXG5pbXBvcnQgeyBDbGllbnQsIE9wdGlvbnMgfSBmcm9tICcuLi9saWIvY2xpZW50JztcclxuXHJcbmxldCBmdHBDbGllbnQ6IENsaWVudDtcclxuXHJcbmNvbnN0IGNsZWFuRXJyb3IgPSAoZXJyOiBFcnJvcik6IEVycm9yID0+IHtcclxuICBjb25zdCBvdXQgPSBjbGVhblN0YWNrKGVyci5zdGFjaywgKGxpbmUpID0+IHtcclxuICAgIGNvbnN0IG0gPSAvKG5vZGVfbW9kdWxlcykvLmV4ZWMobGluZSkgfHwgW107XHJcbiAgICBpZiAobVsxXSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiBsaW5lO1xyXG4gIH0pO1xyXG4gIHJldHVybiBfLmFzc2lnbihlcnIsIHsgc3RhY2s6IG91dC5yZXBsYWNlKC9eW1xcclxcbl17Mix9L2dtLCAnJykgfSk7XHJcbn07XHJcblxyXG5jb25zdCBzZXJ2ZXJGVFBUZXN0ID0ge1xyXG4gIGhvc3Q6ICdmdHAuZGxwdGVzdC5jb20nLFxyXG4gIHBvcnQ6IDIxLFxyXG4gIHVzZXI6ICdkbHB1c2VyQGRscHRlc3QuY29tJyxcclxuICBwYXNzd29yZDogJzNENlhaVjlNS2RoTTVmRicsXHJcbiAgZGVidWc6IChtc2cpID0+IHtcclxuICAgIC8vIGNvbnNvbGUubG9nKCdcXHRcXHRGVFAgLS0+ICcgKyBtc2cpO1xyXG4gIH0sXHJcbn07XHJcblxyXG5jb25zdCBvcHRpb25zOiBPcHRpb25zID0ge1xyXG4gIGxvZ2dpbmc6ICdkZWJ1ZycsXHJcbn07XHJcblxyXG5mdHBDbGllbnQgPSBuZXcgQ2xpZW50KHNlcnZlckZUUFRlc3QsIG9wdGlvbnMpO1xyXG5cclxuZGVzY3JpYmUoJ1Rlc3QgY29ubmVjdGlvbicsIGZ1bmN0aW9uKCkge1xyXG4gIGl0KGBjb25uZWN0IHRvIHRoZSB0ZXN0IHNlcnZlcmAsIGZ1bmN0aW9uKGRvbmUpIHtcclxuICAgIGxldCBjb25uZWN0ZWQgPSBmYWxzZTtcclxuICAgIGZ0cENsaWVudC5jb25uZWN0KCkuc3Vic2NyaWJlKFxyXG4gICAgICAoKSA9PiBjb25uZWN0ZWQgPSB0cnVlLFxyXG4gICAgICBlcnIgPT4gZG9uZShlcnIpLFxyXG4gICAgICAoKSA9PiB7XHJcbiAgICAgICAgZXhwZWN0KGNvbm5lY3RlZCkudG8uYmUudHJ1ZTtcclxuICAgICAgICBleHBlY3QoZnRwQ2xpZW50LnN0YXR1cykudG8uYmUuZXF1YWwoJ2Nvbm5lY3RlZCcpO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgICAgfSxcclxuICAgICk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KGBkaXNjb25uZWN0IGZyb20gdGhlIHRlc3Qgc2VydmVyYCwgZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgbGV0IGNvbm5lY3RlZCA9IHRydWU7XHJcbiAgICBmdHBDbGllbnQuZGlzY29ubmVjdCgpLnN1YnNjcmliZShcclxuICAgICAgKCkgPT4gY29ubmVjdGVkID0gZmFsc2UsXHJcbiAgICAgIGVyciA9PiBkb25lKGVyciksXHJcbiAgICAgICgpID0+IHtcclxuICAgICAgICBleHBlY3QoY29ubmVjdGVkKS50by5iZS5mYWxzZTtcclxuICAgICAgICBleHBlY3QoZnRwQ2xpZW50LnN0YXR1cykudG8uYmUuZXF1YWwoJ2Rpc2Nvbm5lY3RlZCcpO1xyXG4gICAgICAgIGRvbmUoKTtcclxuICAgICAgfSxcclxuICAgICk7XHJcbiAgfSk7XHJcbn0pO1xyXG5cclxuZGVzY3JpYmUoJ1Rlc3QgdXBsb2FkJywgZnVuY3Rpb24oKSB7XHJcbiAgY29uc3QgdGVzdEZpbGVzID0gW1xyXG4gICAgJy4vdGVzdC50eHQnLFxyXG4gICAgJy4vZGlyJyxcclxuICAgICcuL2Rpci8qJyxcclxuICBdO1xyXG4gIGNvbnN0IHJlbW90ZVBhdGggPSAnL3Rlc3QnO1xyXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgdGhpcy50aW1lb3V0KDApO1xyXG4gICAgZnRwQ2xpZW50LmNvbm5lY3QoKS5zdWJzY3JpYmUoe1xyXG4gICAgICBlcnJvcjogZXJyID0+IGRvbmUoZXJyKSxcclxuICAgICAgY29tcGxldGU6ICgpID0+IGRvbmUoKSxcclxuICAgIH0pO1xyXG4gIH0pO1xyXG4gIGFmdGVyRWFjaChmdW5jdGlvbihkb25lKSB7XHJcbiAgICB0aGlzLnRpbWVvdXQoMCk7XHJcbiAgICBmdHBDbGllbnQuY29ubmVjdCgpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGZ0cENsaWVudC5kZWxldGVSZW1vdGVGaWxlKHtcclxuICAgICAgICAgIHNyYzogcmVtb3RlUGF0aCxcclxuICAgICAgICAgIGlzRGlyZWN0b3J5OiAoKSA9PiB0cnVlLFxyXG4gICAgICAgIH0gYXMgYW55KSksXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGZ0cENsaWVudC5kaXNjb25uZWN0KCkpLFxyXG4gICAgKS5zdWJzY3JpYmUoe1xyXG4gICAgICBlcnJvcjogZXJyID0+IGRvbmUoZXJyKSxcclxuICAgICAgY29tcGxldGU6ICgpID0+IGRvbmUoKSxcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBpdChgdXBsb2FkIG9uZSBmaWxlIHRvIHRoZSB0ZXN0IHNlcnZlcmAsIGZ1bmN0aW9uKGRvbmUpIHtcclxuICAgIGZ0cENsaWVudC51cGxvYWQocGF0aC5qb2luKF9fZGlybmFtZSwgdGVzdEZpbGVzWzBdKSxcclxuICAgICAgcmVtb3RlUGF0aCwgeyBiYXNlRGlyOiBfX2Rpcm5hbWUgfSkuc3Vic2NyaWJlKFxyXG4gICAgICAgIHJlc3VsdHMgPT4ge1xyXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdHMsICdObyByZXN1bHRzIHJldHVybmVkJykudG8uZXhpc3Q7XHJcbiAgICAgICAgICBleHBlY3QocmVzdWx0cy51cGxvYWRlZEZpbGVzKS50by5iZS5lcWwoW1xyXG4gICAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCB0ZXN0RmlsZXNbMF0pLFxyXG4gICAgICAgICAgXSk7XHJcbiAgICAgICAgICBleHBlY3QocmVzdWx0cy51cGxvYWRlZERpcnMpLnRvLmJlLmVtcHR5O1xyXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdHMuZXJyb3JzLCAnRXJyb3JzIGRldGVjdGVkJykudG8uYmUuZW1wdHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnIgPT4gZG9uZShlcnIpLFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIGV4cGVjdChmdHBDbGllbnQuc3RhdHVzKS50by5iZS5lcXVhbCgnZGlzY29ubmVjdGVkJyk7XHJcbiAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgfSxcclxuICAgICk7XHJcbiAgfSkudGltZW91dCgyMDAwMCk7XHJcblxyXG4gIGl0KGB1cGxvYWQgbXVsdGlwbGUgZmlsZXMgdG8gdGhlIHRlc3Qgc2VydmVyYCwgZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgZnRwQ2xpZW50LnVwbG9hZChfLm1hcCh0ZXN0RmlsZXMsIHQgPT4gcGF0aC5qb2luKF9fZGlybmFtZSwgdCkpLFxyXG4gICAgICByZW1vdGVQYXRoLCB7IGJhc2VEaXI6IF9fZGlybmFtZSB9KS5zdWJzY3JpYmUoXHJcbiAgICAgICAgcmVzdWx0cyA9PiB7XHJcbiAgICAgICAgICBleHBlY3QocmVzdWx0cywgJ05vIHJlc3VsdHMgcmV0dXJuZWQnKS50by5leGlzdDtcclxuICAgICAgICAgIGV4cGVjdChyZXN1bHRzLnVwbG9hZGVkRmlsZXMpLnRvLmJlLmxlbmd0aCgzKTtcclxuICAgICAgICAgIGV4cGVjdChyZXN1bHRzLnVwbG9hZGVkRGlycykudG8uYmUubGVuZ3RoKDEpO1xyXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdHMuZXJyb3JzLCAnRXJyb3JzIGRldGVjdGVkJykudG8uYmUuZW1wdHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnIgPT4gZG9uZShlcnIpLFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIGV4cGVjdChmdHBDbGllbnQuc3RhdHVzKS50by5iZS5lcXVhbCgnZGlzY29ubmVjdGVkJyk7XHJcbiAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgfSxcclxuICAgICk7XHJcbiAgfSkudGltZW91dCgyMDAwMCk7XHJcbn0pO1xyXG5cclxuZGVzY3JpYmUub25seSgnVGVzdCBkb3dubG9hZCcsIGZ1bmN0aW9uKCkge1xyXG4gIGNvbnN0IHRlc3RGaWxlcyA9IFtcclxuICAgICcuL3Rlc3QudHh0JyxcclxuICAgICcuL2RpcicsXHJcbiAgICAnLi9kaXIvKicsXHJcbiAgXTtcclxuICBjb25zdCByZW1vdGVQYXRoOiBzdHJpbmcgPSAnL3Rlc3QnO1xyXG4gIGNvbnN0IGRvd25sb2FkUGF0aDogc3RyaW5nID0gJy9kb3dubG9hZCc7XHJcblxyXG4gIGJlZm9yZUVhY2goZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgdGhpcy50aW1lb3V0KDApO1xyXG4gICAgZnRwQ2xpZW50LnNldENvbmZpZyhcclxuICAgICAgc2VydmVyRlRQVGVzdCxcclxuICAgICAgXy5hc3NpZ24oXy5jbG9uZShvcHRpb25zKSwge1xyXG4gICAgICAgIGxvZ2dpbmc6ICdub25lJyxcclxuICAgICAgICBiYXNlRGlyOiBfX2Rpcm5hbWUsXHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuICAgIGZ0cENsaWVudC5jb25uZWN0KCkucGlwZShcclxuICAgICAgdGFwKCgpID0+IGNvbnNvbGUuaW5mbygnQmVmb3JlIC0gVXBsb2FkaW5nIHRlc3QgZmlsZXMnKSksXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGZ0cENsaWVudC51cGxvYWQoXy5tYXAodGVzdEZpbGVzLCB0ID0+IHBhdGguam9pbihfX2Rpcm5hbWUsIHQpKSxcclxuICAgICAgICAgIHJlbW90ZVBhdGgpKSxcclxuICAgICAgdGFwKCgpID0+IGNvbnNvbGUuaW5mbygnQmVmb3JlIC0gRmlsZXMgdXBsb2FkZWQsIGNyZWF0aW5nIGZvbGRlciAnXHJcbiAgICAgICAgKyBkb3dubG9hZFBhdGgpKSxcclxuICAgICAgc3dpdGNoTWFwVG8oXHJcbiAgICAgICAgYmluZE5vZGVDYWxsYmFjayhmcy5ta2RpcikuY2FsbCh0aGlzLFxyXG4gICAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgZG93bmxvYWRQYXRoKSkucGlwZShcclxuICAgICAgICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VFWElTVCcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZihudWxsKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyKTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICApKSxcclxuICAgICAgdGFwKCgpID0+IGNvbnNvbGUuaW5mbygnQmVmb3JlIC0gRG9uZScpKSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICBjb25zb2xlLmluZm8oJ0JlZm9yZSAtIFNldCBuZXcgY29uZmlnJyksXHJcbiAgICAgICAgICBmdHBDbGllbnQuc2V0Q29uZmlnKFxyXG4gICAgICAgICAgICBfLmFzc2lnbihfLmNsb25lKHNlcnZlckZUUFRlc3QpLCB7XHJcbiAgICAgICAgICAgICAgbG9nZ2luZzogJ2RlYnVnJyxcclxuICAgICAgICAgICAgICBkZWJ1ZzogKG1zZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1xcdFxcdEZUUCAtLT4gJyArIG1zZyk7XHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIF8uYXNzaWduKF8uY2xvbmUob3B0aW9ucyksIHt9KSxcclxuICAgICAgICAgICk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBzd2l0Y2hNYXBUbyhmdHBDbGllbnQuY29ubmVjdCgpKSxcclxuICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB7XHJcbiAgICAgICAgZnRwQ2xpZW50LnNldENvbmZpZyhzZXJ2ZXJGVFBUZXN0LCBvcHRpb25zKTtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnIpO1xyXG4gICAgICB9KSxcclxuICAgICkuc3Vic2NyaWJlKHtcclxuICAgICAgZXJyb3I6IGVyciA9PiBkb25lKGVyciksXHJcbiAgICAgIGNvbXBsZXRlOiAoKSA9PiBkb25lKCksXHJcbiAgICB9KTtcclxuICB9KTtcclxuICBhZnRlckVhY2goZnVuY3Rpb24oZG9uZSkge1xyXG4gICAgdGhpcy50aW1lb3V0KDApO1xyXG4gICAgZnRwQ2xpZW50LnNldENvbmZpZyhcclxuICAgICAgc2VydmVyRlRQVGVzdCxcclxuICAgICAgXy5hc3NpZ24oXy5jbG9uZShvcHRpb25zKSwge1xyXG4gICAgICAgIGxvZ2dpbmc6ICdub25lJyxcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgY29uc3QgZW5kT2JzZXJ2YWJsZSA9IG9mKG51bGwpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgZnRwQ2xpZW50LnNldENvbmZpZyhzZXJ2ZXJGVFBUZXN0LCBvcHRpb25zKTtcclxuICAgICAgfSksXHJcbiAgICAgIGlnbm9yZUVsZW1lbnRzKCksXHJcbiAgICApO1xyXG4gICAgZnRwQ2xpZW50LmNvbm5lY3QoKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4gY29uc29sZS5pbmZvKCdBZnRlciAtIERpc2Nvbm5lY3RpbmcgYW5kIGNsZWFuaW5nIGZvbGRlcnMnKSksXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGZ0cENsaWVudC5kZWxldGVSZW1vdGVGaWxlKHtcclxuICAgICAgICAgIHNyYzogcmVtb3RlUGF0aCxcclxuICAgICAgICAgIGlzRGlyZWN0b3J5OiAoKSA9PiB0cnVlLFxyXG4gICAgICAgIH0gYXMgYW55KSksXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGJpbmROb2RlQ2FsbGJhY2socmltcmFmKS5jYWxsKHRoaXMsXHJcbiAgICAgICAgICBwYXRoLmpvaW4oX19kaXJuYW1lLCBkb3dubG9hZFBhdGgpKSksXHJcbiAgICAgIHN3aXRjaE1hcFRvKFxyXG4gICAgICAgIGZ0cENsaWVudC5kaXNjb25uZWN0KCkpLFxyXG4gICAgICB0YXAoKCkgPT4gY29uc29sZS5pbmZvKCdBZnRlciAtIERvbmUnKSksXHJcbiAgICAgIGNvbmNhdChlbmRPYnNlcnZhYmxlKSxcclxuICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGVuZE9ic2VydmFibGUucGlwZShcclxuICAgICAgICAgIG1hcFRvKHRocm93RXJyb3IoZXJyKSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSksXHJcbiAgICApLnN1YnNjcmliZSh7XHJcbiAgICAgIGVycm9yOiBlcnIgPT4gZG9uZShlcnIpLFxyXG4gICAgICBjb21wbGV0ZTogKCkgPT4gZG9uZSgpLFxyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGl0KGBEb3dubG9hZCBhIGZvbGRlciBmcm9tIHRoZSB0ZXN0IHNlcnZlcmAsIGZ1bmN0aW9uKGRvbmUpIHtcclxuICAgIGNvbnN0IGxvY2FsRmlsZVBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCBkb3dubG9hZFBhdGgsIHRlc3RGaWxlc1swXSk7XHJcbiAgICBmdHBDbGllbnQuZG93bmxvYWQocmVtb3RlUGF0aCwgcGF0aC5qb2luKF9fZGlybmFtZSwgZG93bmxvYWRQYXRoKSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcigoZXJyKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGZ0cENsaWVudC5kaXNjb25uZWN0KCkucGlwZShcclxuICAgICAgICAgIHN3aXRjaE1hcFRvKHRocm93RXJyb3IoZXJyKSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSksXHJcbiAgICApXHJcbiAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgcmVzdWx0cyA9PiB7XHJcbiAgICAgICAgICBleHBlY3QocmVzdWx0cywgJ05vIHJlc3VsdHMgcmV0dXJuZWQnKS50by5leGlzdDtcclxuICAgICAgICAgIGV4cGVjdChyZXN1bHRzLmRvd25sb2FkZWRGaWxlcykudG8uYmUubGVuZ3RoKDMpO1xyXG4gICAgICAgICAgZXhwZWN0KHJlc3VsdHMuZXJyb3JzLCAnRXJyb3JzIGRldGVjdGVkJykudG8uYmUuZW1wdHk7XHJcbiAgICAgICAgICBleHBlY3QoZmlsZShwYXRoLmpvaW4obG9jYWxGaWxlUGF0aCkpKS50by5leGlzdDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVyciA9PiBkb25lKGVyciksXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgZXhwZWN0KGZ0cENsaWVudC5zdGF0dXMpLnRvLmJlLmVxdWFsKCdkaXNjb25uZWN0ZWQnKTtcclxuICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICB9LFxyXG4gICAgKTtcclxuICB9KS50aW1lb3V0KDIwMDAwKTtcclxufSk7XHJcbiJdLCJzb3VyY2VSb290IjoiLi4ifQ==
